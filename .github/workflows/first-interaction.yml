name: Thank You on Merge

on:
  pull_request:
    types: [closed]

jobs:
  thank-you:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    # ðŸ‘‡ ADD THIS PERMISSIONS BLOCK
    permissions:
      issues: write
      pull-requests: write
      contents: read
    # ðŸ‘† END OF ADDITION

    steps:
      - name: Check for previous contributions
        id: check_contrib
        uses: actions/github-script@v6
        with:
          script: |
            const creator = context.payload.pull_request.user.login;
            const { owner, repo } = context.repo;
            const { data: items } = await github.rest.search.issuesAndPullRequests({
              q: `is:pr is:merged author:${creator} repo:${owner}/${repo}`
            });
            console.log(`Merged PR count for ${creator}: ${items.total_count}`);
            return items.total_count;

      - name: Comment on First Contribution
        if: steps.check_contrib.outputs.result == '1'
        uses: actions/github-script@v6
        with:
          script: |
            const creator = context.payload.pull_request.user.login;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ **Congratulations, @${creator}!** ðŸš€\n\nYour first Pull Request has just been merged! Thank you so much for your contribution to **Smart Attendance**.\n\nWelcome to the team of contributors! We hope this is the first of many. Happy coding! ðŸ’»âœ¨`
            });

      - name: Comment on Recurring Contribution
        if: steps.check_contrib.outputs.result > '1'
        uses: actions/github-script@v6
        with:
          script: |
            const creator = context.payload.pull_request.user.login;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Merged!**\n\nThanks again, @${creator}, for another great contribution! Your changes are now live.\n\nKeep up the awesome work ðŸš€`
            });
